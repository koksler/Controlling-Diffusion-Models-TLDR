[[01_GAN_Модели]]
# Диффузионные модели

Диффузионки работают как реставраторы. В самой базе они генерируют канвас шума и постепенно, частями удаляют его, заменяя на что-то осмысленное, базируясь на промпте. Тем самым, для диффузионнок процесс генерации это не единоразовое событие, а что-то постепенное.

![[generative-overview.png]]
[отседова](https://lilianweng.github.io/posts/2021-07-11-diffusion-models/)

Строиться это на двух процессах, прямом и обратном.

> [!info] Определение
> ### Прямой процесс
> Добавление шума к исходному изображению по шагам, **пока оно полностью не будет выглядеть как обычный шум**. При этом это добавление математически определено, оно не истинно случайное. 
> 
> Из этого шума обратный процесс реставрирует какую-либо картинку

![[Зашумление в диффузках 2.png]]

Происходит зашумление по Гауссу, формула что-то вроде этого

$$q(x_t | x_{t-1}) = N(x_t; sqrt(1 - \beta_t) * x_{t-1}, \beta_{t * I)} \ \ \ \ \ \text{(Для одного шага)}$$

- $x_t$ - изображение на шаге t (более шумное), $x_{t-1}$ - на предыдущем.
- $N(...)$ - функция Гауссовского распределения
- $\beta_t$ (бета) - маленькое число, контролирующее число добавляемого шума на шаге. С каждым шагом мы добавляем больше шума
- $sqrt(1 - \beta_t) * x_{t-1}$ - Для масштабирования старого изображения. Оригинал уменьшается на число меньше одного, освобождая место под шум.
- $\beta_t * I$ - Дисперсия, шоб шум был шумом (т.е. рандомным, хаотичным). Тут $I$ - это единичная матрица, которая должна обеспечить независимость распределение шума

Есть формула шустрее, которая зашумляет изображение в один шаг
$$q(x_t | x_0) = N(x_t; sqrt(\bar{\alpha}_t) * x_0, (1 - \bar{\alpha}_t) * I)$$
Добавилась $\alpha_t = 1 - \beta_t, а \bar{\alpha}_t$, это произведение всех $\alpha$ до шага $t$. Альфа это сокращение для $1- \beta_{t}$. С чертой это произведение всей фигни.


> [!info] Определение
> ### Обратный процесс (Восстановление)
> Модель, обученная на зашумленных (оригинал-шум) картинках пытается постепенно восстановить рандомный шум, основываясь на закономерностях полученных при обучении. 
> 
> Например, какой-то шум может напоминать шум какого-то элемента из промпта, и что-то появиться как раз на этом месте.

Диффузионная модель в восстановлении отвечает только за удаление шума. Как удалять этот шум мы ей говорим через текстовые энкодеры. Для SD это CLIP (сделал альтман и компания)

Сначала промпт разбивается на токены, по классике
```Prompt

1. a photorealistic painting of a red dragon
   
2. [a, photo, realistic, paint, ing, of, a, red, dragon]
   
3. [49406, 1282, ... числа для слов из словаря ..., 318, 49406, 831, 5158, 49407]
```

Потом, энкодер берёт это и проводит его через трансформер (как в LLM, которая находит смысловые связи между векторами слов и связывает их)

- Вектор слова **dragon** будет содержать информацию о том, что он **red**.
- Вектор слова **painting** будет нести отпечаток того, что оно **photorealistic**.

На выходе получается набор эмбеддингов, или математическое определение промпта. Тут вступает механизм Cross Attention

> [!info] Определение
> ### Cross Attention
> На разных уровнях обработки, нейросеть останавливает восстановление. Она берет текущее состояние изображения (которое все еще шумное, но уже с какими-то формами) и **сравнивает** его с векторами на эмбеддингах. Механизм внимания определяет, какие части изображения **наиболее релевантны** каким словам в промпте.
> 
> U-Net видит в шуме какую-то закономерность, которая похожа на что-то из промпта. Cross-Attention говорит: "Тут есть что-то похожее на эмбеддинг, рисуем тут эту часть".
> 
> То есть Cross-Attention даёт подсказки U-Net о том, где и как что рисовать (удалять шум), и U-Net на основе своей тренировки пытается изобразить в этом месте конкретно эту вещь.

# Тесты

**Text-to-Image**, Euler+Normal / DPM 2m + Karras

**Воркфлоу:**

![[Мать моя диффузия.png]]

> Построен на последовательном прогоне двух семплеров и сохранении финального результата + процесса генерации в видео, с частотой 1кадр/с, дабы можно было легче проследить за каждым шагом (их 30). 

```Prompt

masterpiece, best quality, photorealistic, a crystal sphere shaped bottle filled with beer, oak table, cozy background
```

Вот так выглядит процесс восстановления для двух семплеров

![[Text to Image.png]]

Euler намного, НАМНОГО дольше приходил к подобию результата. DPM практически сразу получил какие-то формы объекта и с 12-13 сэмлпа практически не изменял результат, дорабатывая крайне мелкие детали.

Финальный результат на одном сиде отличается полностью

![[Text to Image (Прямое сравнение).png]]

**DPM + Karras** выглядит мягче, реалистичнее. **Euler** слишком резкий и контрастный.

Оба семплера поняли требование с кристальной бутылкой, но Euler более точно передал сферу в бутылке. DPM сделал скругление более реалистичным, похожим на обычную пивную бутылку, но при этом отклонился от промпта (что на таком cfg ожидаемо)

Обе модели справились со столом. У DPM он более детализированный, как и сама бутылка. Но фон у Эйлера чуть более детализированный и больше соответствует промпту.

В целом можно сказать, что Karras позволяет себе больше вольностей, чтобы фото было более реалистичным, а Euler точнее следует промпту.

**Формализуем**
### Euler + Normal

Эйлер более склонен быть буквальным с промптом, мало что изменяя. Это из-за того, что он детерменированный семплер

**Что-то хорошее**

Он сгенерировал именно сферическую бутылку, даже если это выглядит неестественно. Это показывает, что его алгоритм поиска в латентном пространстве жестко привязан к семантике текста.

Также фон более подходящий промпту, более детализированный, хоть и размытый

**Что-то плохое**

Освещение слишком резкое и искусственное.

Пена идеальной формы, форма бутылки неестественная (помимо сферической формы это правильно, но она выглядит вросшей)

Промпт выполнен буквально, что хорошо, но получилось не то, что подразумевал человек. Был убит здравый смысл

### DPM 2M + Karras

Этот сэмплер демонстрирует **приоритет правдоподобия (Plausibility)** над буквальным следованием промпту.

**Что-то хорошее**

Центральный объект более детализированный, освещение мягкое и естественное. Форма бутылки более гармоничная, но не так соответствует промпту. В целом результат более натуральный.

Семплер "исправил" нелогичность промпта и сгенерировал более-менее реалистичное решение, всё ещё близкое к промпту. Она всё ещё округлая, хоть меньше. Тут Karras воспользовался низким значением cfg (3.5), который позволяет вольности.

**Что-то плохое**

Само по себе отклонение от промпта плохое, даже если результат от этого лучше.

Фон намного более простой и не соответствует промпту. Весь фокус ушел на генерацию центрального объекта

Тем самым, Эйлер более буквальный (из-за его архитектуры), а DPM и Karras более артистичные и самовольные.

Это потому что DPM - многошаговый сэмплер, а Karras предназначен для более художественной планировки, с более смелыми подходами к восстановлению. Vногошаговые решатели, такие как DPM 2M, значительно более эффективны, чем классические одношаговые методы вроде Euler.

пачему

****
[[03_Сэмплеры]]
#diffusers 
