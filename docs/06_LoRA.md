[[05_Diffusion_Fine_Tuning]]
# LoRA


В техническом плане fine-tuning это очень затратный процесс. Это разморозка всех весов модели и внедрение в неё же новых данных. Это круто если нам нужно полностью переадаптировать модель под какой-то строго выраженный общий стиль (Аниме, Акварель).

В итоге получается новая модель, идеально заточенная под конкретную стилистику, как было видно в прошлом сравнении. Но, чаще всего нужно добавлять что-то более мелкое: стиль автора (осуждаем), улучшить точность определенного объекта и так далее. Это более локально и каждый раз делать новую модель для такого очень дорого и времезатратно.

Так появилась **LoRA (Low-Rank Adaptation)** - 

> [!info] Определение
> ### LoRA 
> Метод, который позволяет не трогать основную модель, а добавить к ней надстройку.

**Как это работает на техническом уровне:**

1. Мы берем оригинальную модель и полностью замораживаем все ее миллиарды весов. Мы к ним не прикасаемся.
2. В ключевые слои модели (обычно в слои Cross-Attention) мы внедряем две очень маленькие, специально инициализированные матрицы (матрицы A и B). Эти матрицы имеют низкий ранг (low-rank), отсюда и название.
3. Теперь мы обучаем только эти крошечные матрицы. Вместо миллиардов параметров обучаются всего несколько миллионов. Это на порядок быстрее и дешевле.
4. Обученные матрицы A и B сохраняются в отдельный, очень маленький файл. Во время генерации она подключается к основной модели и корректирует ее поведение в нужных местах.

В конце концов мы наслаиваем новую семантику на уже запечённую модель и она учится генерировать новые вещи / старые вещи, но точнее.

| Критерий               | **Fine-tuning (Полное дообучение)**                                         | **LoRA (Низкоранговая адаптация)**                                                                    |
| :--------------------- | :-------------------------------------------------------------------------- | :---------------------------------------------------------------------------------------------------- |
| **Что меняет**         | Все веса модели                                                             | Не трогает веса модели, наслаивает новые обученные микромодели                                        |
| **Результат**          | Большая модель на несколько Гб                                              | Модель-патч на несколько Мб                                                                           |
| **Гибкость**           | Низкая                                                                      | Высокая, можно подключать несколько лор и менять степень их воздействия                               |
| **Ресурсы (обучение)** | Очень высокие (мин VRAM 24 Гб)                                              | Низкие, обучаемое на потребительских GPU (>8Гб)                                                       |
| **Качество**           | Максимально высокое, модель полностью адаптируется под новую задачу         | Может быть ниже, но всё ещё достойное                                                                 |
| **Применение**         | Создание фундаментально новых базовых моделей (как Juggernaut, Dreamshaper) | Стилизация, обучение конкретных персонажей, добавление концепций, исправление дефектов базовой модели |

## Тесты

```
masterpiece, best quality, an old lighthouse standing on a rocky cliff, dramatic stormy sea, huge waves crashing against the rocks, epic sunset
```

```
masterpiece, best quality, a cluttered desk, an inventor's workshop, covered with blueprints, strange mechanical gadgets, glowing glass tubes, scattered tools, illuminated by a single warm desk lamp
```

```
masterpiece, best quality, low-angle shot, view of a Italian suburb, rainy, dozen puddles, cracked pavement, dark cloudy weather
```

![[Сравнение по LoRA.png]]


Watercolor полностью переопределяет метод рендеринга, заставляя модель имитировать конкретную художественную технику - акварель. Она изменяет текстуры, линии и способ смешения цветов.

**Генерация №1:** Цвета стали более сглаженными, а текстура более смазанной.
**Генерация №2:** Стиль стал более мультяшным, а композиция стала менее реалистичной (до абсурда, стол стоит на другом столе, более мелкий похож на модель).

Основная цель: Быстрое создание художественных эскизов и иллюстраций в заданной технике

VintageXL работает в первую очередь с цветокоррекцией, контрастом и зернистостью, имитируя эстетику старых фотографий или пленочной живописи.

**Генерация №1:** Маяк стал слегка менее ярким, освещение сильно не изменилось
**Генерация №2**: Цвета приобрели стиль старых комиксов (Marvel, DC), композиция особо не изменилась.
**Генерация №3:** Резко добавляется реалистичность, стилизованность практически отстутствует. Цвета стали чуть насыщеннее, скорее всего из-за мимикрии под фотографию.

Основная цель: Придание изображениям ностальгической, винтажной или драматической атмосферы. Использование в качестве "умного" фильтра для стилизации фотографий.

CityWorlds нацелена на детализацию архитектуры, с примесью киберпанка в весах. Она изменяет семантику почти полностью.

**Генерация №1**:  Картинка стала темнее, и слегка острее на краях элементов.
**Генерация №2:** Объекты стале четче, сцена стала темнее и более острой. Стиль намного более приземлённый
**Генерация №3:** Сцена стала кинематографичной по цветам и деталям, картинка стала более объёмной, с воздействием "атмосферы" на освещением (легкая дымка).

Основная цель: Усиление реализма в сценах, удаление лишних художественных деталей, улучшение фона

****
[[07_ControlNET]]