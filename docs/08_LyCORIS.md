[[07_ControlNET]]
# LyCORIS

Это продолжение технологии [[06_LoRA]], но осмысленное именно для генерации диффузионных изображений, а не просто для генеративных моделей.

Наибольшее значение в диффузионных моделях играют сверточные слои, с которыми LoRA не работает. Если их изменить, можно изменить текстуры, анатомию и кучу мелких деталей, которые общий подход Лор изменить может только очень слабо.

> [!info] 
> ### LyCORIS 
> Это не одна модель, а семейство (фреймворк) продвинутых техник адаптации, которые были разработаны, чтобы обучить идею низкоранговой адаптации (то есть лору) работать с **любыми типами слоев**, в первую очередь - со сверточными.

### LoCON (LoRA for Convolutional Networks)

Применяет тот же самый принцип LoRA (разложение на две маленькие матрицы A и B) к сверточным слоям (Conv2D)

### LoHA (LoRA with Hadamard Product)

Вместо того чтобы прибавлять к основному весу маленькую матрицу-коррекцию (как LoRA), LoHA умножает основной вес на матрицу-коррекцию. Это делается с помощью произведения Адамара (поэлементного умножения). 

Так делает Лора:

$$
\underbrace{W_{new}}_{\text{Новые веса}} = \underbrace{W_{orig}}_{\text{Оригинал (заморожен)}} + \underbrace{B \cdot A}_{\text{Маленькая коррекция (обучается)}}
$$

Адамар выглядит так:

$$
\text{Если } M =
\begin{bmatrix}
a & b \\
c & d
\end{bmatrix}
\text{ и } N =
\begin{bmatrix}
e & f \\
g & h
\end{bmatrix}
$$

$$
\text{То их произведение Адамара } M \circ N =
\begin{bmatrix}
a \cdot e & b \cdot f \\
c \cdot g & d \cdot h
\end{bmatrix}
$$

И из этого, Лоха:

$$
\underbrace{W_{new}}_{\text{Новые веса}} = \underbrace{W_{orig}}_{\text{Оригинал (заморожен)}} \circ \underbrace{(B \cdot A)}_{\text{Маленький "масштабатор" (обучается)}}
$$

Примечание: в реальной реализации формула чуть сложнее, например, `W_orig ∘ (1 + B ⋅ A)`, чтобы избежать обнуления весов, но принцип мультипликативности сохраняется)

Этот метод часто оказывается более "выразительным". Он может достичь такого же или даже лучшего результата, используя еще меньше обучаемых параметров, чем LoRA. Он изменяет веса более "глобально".

---

Существуют иные методы в семействе LyCORIS, использующие разные математические трюки (например, произведение Кронекера в LoKR). Они решают ту же задачу, что и два метода выше, но другими способами.

---

### Сравнение Lora и Lycoris

```
masterpiece, best quality, portrait of a knight in intricate golden chainmail armor, detailed filigree, cinematic lighting
```

![[Lora vs Lycoris.png]]

****
[[09_IP-Adapter]]

