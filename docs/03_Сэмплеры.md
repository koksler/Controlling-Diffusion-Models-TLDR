[[02_Диффузионные_модели]]
# Базовые сэмплеры

> [!info] Определение
> ### Одношаговые сэмлеры (Euler)
> Прямолинейный и старый метод решения обыкновенных дифференциальных уравнений, через которые и представляется процесс восстановления
> 
> Для вычисления следующего состояния ему нужен прошлый шаг, делает он свою работу постепенно, шаг за шагом. Формально он смотрит на текущее состояние $x_t$ (картинка) и на предсказание модели (направление "очистки"), а затем делает один **прямой шаг** в этом направлении. $x_{t-1} = x_t + шаг * направление$.
> 
> Продолжение, Euler Ancestral добавляет немного шума с каждым проходом, делая изображение более разнообразным

> [!info] Определение
> ### Многошаговые сэмплеры (DPM)
> Более свежий метод. Для вычисления следующего состояния $x_{t-1}$ он использует информацию не только о текущем состоянии $x_t$, но и о **предыдущих** состояниях ($x_{t+1}$, $x_{t+2}$ и т.д.). Он [[Экстраполяция|экстраполирует]] траекторию очистки, делая каждый шаг одновременно больше и точнее.

Стандатные ДПМ и Эйлер, хоть и разные, но оба **детерменированные**. Они своего рода "линейные" (если очень сильно упрощать). Они только разшумляют шум, не добавляя нового.

Добавлением нового шума занимаются **стохастические сэмплеры** (ancestral). На каждом шагу он добавляет немного шума, сдвигая генерацию. На одном и том же сиде всё ещё будет одно и то же изображение, но кол-во шагов будет существенно менять генерацию.

![[Euler и Euler_a на шагах.png]]

Высокая разница между шагахами на стохастических сэмплерах исходит из флуктуаций генерации, из-за того самого доп-шума. У таких сэмплеров огромная творческая свобода, которая добавляет мелких деталей и отдаляет генератор от исходного промпта.

При этом, на низких шагах стохастический сэмплер явно начинает больше походить на то, что указано в промпте. Так как шагов меньше - меньше стороннего шума, который добавляет алгоритм. И, следовательно, меньше флуктуаций в генерации, меньше своевольности.

> **То есть, стохастические сэмплеры нужны нам, если к генерации нужно добавить мелких деталей, и дать алгоритму свободу интерпретации. Мы жертвуем точностью ради разнообразия.**

> [!info] Определение
> ### Стохастические (Ancestral) сэмплеры
> Сэмплер, в чей алгоритм добавлено намеренное внесение случайной компонеты. В случае с диффузионными моделями это чаще всего гауссовский шум.
> 
> $$x_{t-1} = (\text{детерминированная часть}) + (\text{случайная часть})$$
> $$x_{t-1} = f(x_{t}, t) + \sigma_{t} \cdot z$$
> 
> Тут мы добавляем коэффициент $\sigma$ (сила шума) помноженный на вектор случайности $z$. Таким образом мы подмешиваем на каждом шаге что-то новое. Это позволяет сэмплеру расширить область возможных решений.

Можно зайти дальше, взяв SDE (Stochastic Differential Equation), вместо ОДУ. Теперь мы вычисляем весь процесс как Стохастическое Дифференциальное Уравнение.

Это уравнение, в котором уже есть непрерывная случайная константа (Умные люди называют это Винеровский процесс или Броуновское движение). Сам процесс восстановления настроен на добавление случайности.

SD3 SDE поддерживает плохо, ибо не все сэмплеры умеют переводить v-prediction (более сложный тип предсказания, где модель одновременно предсказывает и шум, и "чистое" изображение (x0)) в epsilon. В частности, это и dpmpp_2m_sde. Выходит вызженное изображение:

![[dpm sde_00002_.png]]

Поэтому в тесте детерменированного сэмплера и SDE посмотрим на разницу на старенькой SDXL.

![[DPM2M и DPM2M_SDE 1.png]]

Ситуация схожа с обыкновенным стохастическим сэмплером, что, в целом, ожидаемо. Принцип тот же.

> [!tip] Отдельно
> ### Karras
> Это планировщик шума (сделали в нвидево), который уплотняет шаги в начале, пока шума много и делает обратное в конце, когда его мало.

****
[[04_Параметры_Генерации]]
#diffusers 
